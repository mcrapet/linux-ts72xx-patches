From 1dd340005e3d08666b4d770c566cf0abfb7ba0af Mon Sep 17 00:00:00 2001
From: Matthieu Crapet <mcrapet@gmail.com>
Date: Wed, 14 Jan 2009 13:26:32 +0100
Subject: [PATCH 06/22] ts7200_physmap_fix

---
 arch/arm/mach-ep93xx/ts72xx.c |   10 ++++++++--
 1 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-ep93xx/ts72xx.c b/arch/arm/mach-ep93xx/ts72xx.c
index 5e5a910..aa40c5f 100644
--- a/arch/arm/mach-ep93xx/ts72xx.c
+++ b/arch/arm/mach-ep93xx/ts72xx.c
@@ -142,13 +142,14 @@ static void __init ts72xx_map_io(void)
 
 /* NOR flash (TS-7200 only) */
 
+#if defined(CONFIG_MTD_PHYSMAP) || defined(CONFIG_MTD_PHYSMAP_MODULE)
 static struct physmap_flash_data ts72xx_flash_data = {
-	.width		= 1,
+	.width		= 2,
 };
 
 static struct resource ts72xx_flash_resource = {
 	.start		= TS72XX_NOR_PHYS_BASE,
-	.end		= TS72XX_NOR_PHYS_BASE + 0x00ffffff,
+	.end		= TS72XX_NOR_PHYS_BASE + SZ_16M - 1,   /* SZ_8M for 8mb flash */
 	.flags		= IORESOURCE_MEM,
 };
 
@@ -161,6 +162,7 @@ static struct platform_device ts72xx_flash = {
 	.num_resources	= 1,
 	.resource	= &ts72xx_flash_resource,
 };
+#endif
 
 /* Real time clock  */
 
@@ -222,8 +224,12 @@ static struct platform_device ts72xx_eth_device = {
 static void __init ts72xx_init_machine(void)
 {
 	ep93xx_init_devices();
+
+	#if defined(CONFIG_MTD_PHYSMAP) || defined(CONFIG_MTD_PHYSMAP_MODULE)
 	if (board_is_ts7200())
 		platform_device_register(&ts72xx_flash);
+	#endif
+
 	platform_device_register(&ts72xx_rtc_device);
 
 	memcpy(ts72xx_eth_data.dev_addr,
-- 
1.5.6.5

