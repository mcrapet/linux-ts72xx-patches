From 06d0e349522dc0022f4dd1d0d34368568007c10f Mon Sep 17 00:00:00 2001
From: Matthieu Crapet <mcrapet@gmail.com>
Date: Sun, 5 Apr 2009 13:36:50 +0200
Subject: [PATCH 05/23] ts7200_physmap_fix

---
 arch/arm/mach-ep93xx/ts72xx.c |   10 ++++++++--
 1 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-ep93xx/ts72xx.c b/arch/arm/mach-ep93xx/ts72xx.c
index 3dbae74..fd5c7fa 100644
--- a/arch/arm/mach-ep93xx/ts72xx.c
+++ b/arch/arm/mach-ep93xx/ts72xx.c
@@ -143,13 +143,14 @@ static void __init ts72xx_map_io(void)
 
 /* NOR flash (TS-7200 only) */
 
+#if defined(CONFIG_MTD_PHYSMAP) || defined(CONFIG_MTD_PHYSMAP_MODULE)
 static struct physmap_flash_data ts72xx_flash_data = {
-	.width		= 1,
+	.width		= 2,
 };
 
 static struct resource ts72xx_flash_resource = {
 	.start		= TS72XX_NOR_PHYS_BASE,
-	.end		= TS72XX_NOR_PHYS_BASE + SZ_16M - 1,
+	.end		= TS72XX_NOR_PHYS_BASE + SZ_16M - 1, /* SZ_8M for 8mb flash */
 	.flags		= IORESOURCE_MEM,
 };
 
@@ -162,6 +163,7 @@ static struct platform_device ts72xx_flash = {
 	.num_resources	= 1,
 	.resource	= &ts72xx_flash_resource,
 };
+#endif
 
 /* Real time clock  */
 
@@ -198,8 +200,12 @@ static struct ep93xx_eth_data ts72xx_eth_data = {
 static void __init ts72xx_init_machine(void)
 {
 	ep93xx_init_devices();
+
+#if defined(CONFIG_MTD_PHYSMAP) || defined(CONFIG_MTD_PHYSMAP_MODULE)
 	if (board_is_ts7200())
 		platform_device_register(&ts72xx_flash);
+#endif
+
 	platform_device_register(&ts72xx_rtc_device);
 
 	ep93xx_register_eth(&ts72xx_eth_data, 1);
-- 
1.6.2.1

